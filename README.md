# Выпускная работа IT-школы Протей: Мини-PGW

## Результат работы
Разработана упрощённая модель сетевого компонента PGW (Packet Gateway), 
способная обрабатывать UDP-запросы, управлять сессиями абонентов по IMSI, 
вести CDR-журнал, предоставлять HTTP API, поддерживать чёрный список IMSI и корректно завершать работу.

## Архитектура работы

### Проект состоит из:
* **pgw_server**: Основное серверное приложение. Запускает UDP-сервер для обработки запросов от абонентов и HTTP-сервер для предоставления API. Использует pgw_core для всей бизнес-логики.
* **pgw_clint**: Консольное клиентское приложение для тестирования сервера. Отправляет UDP-пакет с IMSI и выводит ответ.
* **libs/common**: Общий код, используемый и клиентом, и сервером. Включает загрузку конфигурации, настройку логгера, BCD кодирование/декодирование и RAII класс для сокета.
* **libs/pgw_core**: Ядро приложения. Содержит session_manager, который управляет сессиями, cdr_writer для записи cdr в файл и RAII класс для epoll.
* **configs**: Примерные файлы для конфигурации клиента и сервера.
* **tests**: Unit-тесты для общей библиотеки и основного ядра приложения.

## Используемые зависимости
Все зависимости скачиваются и собираются с помощью CMake:
* **nlohmann/json**: для работы с JSON-конфигурацией.
* **spdlog**: для логирования.
* **cpp-httplib**: для реализации HTTP-сервера.
* **googletest**: для юнит-тестирования.

## HTTP API
PGW сервер запускает HTTP сервер по настройкам из конфига.

### Проверка сессии абонента:
* URL: /check_subscriber
* Метод: GET
* Параметры: imsi
* Пример: curl localhost:8080/check_subscriber?imsi=123456789012345
* Ответ: active или not active

### Остановка сервера:
* URL: /stop
* Метод: GET
* Пример: curl localhost:8080/stop
* Ответ: Остановка запущена

## Сборка и запуск

### Проект собирается через cmake:

```bash
1. Клонировать репозиторий
git clone https://github.com/urusofam/pgw-protei
cd pgw-protei

2. Создать каталог для сборки
mkdir build
cd build

3. Сконфигурировать проект с помощью CMake
cmake ..

4. Собрать проект
make
```

### Запуск unit-тестов:

```bash
Находясь в каталоге build/
cd tests
ctest
```

В проекте есть unit-тесты для:
* BCD кодирования/декодирования
* Работы с конфигурационными файлами
* CDR writer
* Session manager
* Логирования

### Запуск сервера:

```bash
Находясь в каталоге build/
./pgw_server/pgw_server
```
Сервер запускается с конфигурацией из configs/server.json


### Запуск клиента:

```bash
Находясь в каталоге build/
./pgw_client/pgw_client <IMSI>
```
Клиент запускается с конфигурацией из configs/client.json

## Конфигурации

### Для сервера:

```json
{
  "udp_ip": "0.0.0.0",              IP адрес UDP сервера
  "udp_port": 9000,                 Порт UDP сервера
  "udp_buffer_size": 1024,          Размер буфера UDP
  "epoll_max_events": 10,           Максимальное количество событий epoll
  "epoll_timeout_sec": 1,           Таймаут epoll (секунды)
  "session_timeout_sec": 5,         Таймаут сессии (секунды)
  "cdr_file": "cdr.csv",            Имя файла CDR
  "http_ip": "0.0.0.0",             IP адрес HTTP сервера
  "http_port": 8080,                Порт HTTP сервера
  "graceful_shutdown_rate": 10,     Скорость закрытия сессий (сессий/сек)
  "log_file": "server.log",         Имя файла логов
  "log_level": "info",              Уровень логирования
  "blacklist": [                    Список заблокированных IMSI
    "001010123456789",
    "001010000000001"
  ]
}
```

### Для клиента:
```json
{
  "server_ip": "127.0.0.1",         IP адрес сервера
  "server_port": 9000,              Порт сервера
  "udp_buffer_size": 1024,          Размер буфера UDP
  "udp_timer_sec": 5,               Таймаут ожидания ответа
  "log_file": "client.log",         Имя файла логов
  "log_level": "info"               Уровень логирования
}
```

## Протокол UDP

#### Клиент отправляет IMSI в формате BCD. Возможные ответы сервера:

* created - новая сессия успешно создана
* rejected - запрос отклонен (IMSI в блэклисте или сессия уже существует)

## CDR формат 

#### CDR записи сохраняются в формате timestamp,imsi,action

## Логирование

#### Поддерживаемые уровни логирования:

* debug
* info
* warn
* error
* critical

Логи выводятся одновременно в консоль и в файл в директории logs/.
